#!/bin/bash

# Скрипт для обновления кода на сервере, пересборки и запуска проекта
# Использование: ssh root@194.87.54.64 < update-server.sh
# Или выполните команды вручную на сервере

set -e

echo "=========================================="
echo "Обновление кода на сервере"
echo "=========================================="

# Переход в директорию проекта
cd /root/afrodita || cd /root/Afrodita

echo "Текущая директория: $(pwd)"

# Обновление кода из GitHub
echo "Обновление кода из GitHub..."
git pull origin main

# Остановка контейнеров
echo "Остановка контейнеров..."
docker compose down

# Пересборка образов
echo "Пересборка Docker образов..."
docker compose build --no-cache

# Запуск контейнеров
echo "Запуск контейнеров..."
docker compose up -d

# Ожидание запуска
echo "Ожидание запуска сервисов..."
sleep 10

# Проверка статуса
echo "Проверка статуса контейнеров..."
docker compose ps

echo "=========================================="
echo "Обновление завершено"
echo "=========================================="

# Подключение к БД и удаление регистраций администраторов
echo "Подключение к БД для удаления регистраций администраторов..."
docker compose exec -T postgres psql -U afrodita_user -d afrodita << EOF
-- Удаление всех регистраций администраторов
DELETE FROM users WHERE role = 'admin';

-- Показать оставшихся пользователей
SELECT id, email, role, "firstName", "lastName" FROM users;
EOF

echo "Регистрации администраторов удалены"

