#!/bin/sh
set -e

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞ –¥–ª—è shared –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (–¥–ª—è dev —Ä–µ–∂–∏–º–∞ —Å volume)
if [ ! -L /app/shared ] && [ -d /shared ]; then
  echo "üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞ –¥–ª—è shared..."
  ln -sf /shared /app/shared
  echo "‚úÖ –°–∏–º–ª–∏–Ω–∫ —Å–æ–∑–¥–∞–Ω: /app/shared -> /shared"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ shared
if [ -d /shared ] || [ -L /app/shared ]; then
  echo "‚úÖ Shared –¥–æ—Å—Ç—É–ø–µ–Ω"
  if [ -f /shared/types/index.ts ] || [ -f /app/shared/types/index.ts ]; then
    echo "‚úÖ Shared types –Ω–∞–π–¥–µ–Ω—ã"
  else
    echo "‚ö†Ô∏è  Shared types –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
  fi
else
  echo "‚ö†Ô∏è  Shared –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞ –¥–ª—è shared –≤ src (–¥–ª—è TypeScript rootDir)
if [ ! -e /app/src/shared ] && [ -d /shared ]; then
  echo "üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞ –¥–ª—è shared –≤ src..."
  ln -sf /shared /app/src/shared
  echo "‚úÖ –°–∏–º–ª–∏–Ω–∫ —Å–æ–∑–¥–∞–Ω: /app/src/shared -> /shared"
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∏–º–ª–∏–Ω–∫–∞ main.js (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏)
create_main_symlink() {
  if [ -f /app/dist/app/src/main.js ] && [ ! -f /app/dist/main.js ]; then
    echo "üîó –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞ –¥–ª—è main.js..."
    mkdir -p /app/dist
    ln -sf app/src/main.js /app/dist/main.js
    echo "‚úÖ –°–∏–º–ª–∏–Ω–∫ —Å–æ–∑–¥–∞–Ω: /app/dist/main.js -> app/src/main.js"
  fi
}

# –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å —Å–∏–º–ª–∏–Ω–∫ —Å—Ä–∞–∑—É (–µ—Å–ª–∏ dist —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
create_main_symlink

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–ª–∏–Ω–∫–∞ –≤ —Ñ–æ–Ω–µ –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (–¥–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ dist —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–∑–∂–µ)
(sleep 20 && create_main_symlink) &

echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ bcrypt –¥–ª—è —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã..."

# –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º bcrypt –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —Ç–∞–∫ –∫–∞–∫ bcrypt –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –Ω–∞—Ç–∏–≤–Ω–æ –∏ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
if npm uninstall bcrypt 2>/dev/null; then
  echo "üì¶ –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π bcrypt"
fi

echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ bcrypt –¥–ª—è —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã..."
if npm install bcrypt --no-save; then
  echo "‚úÖ bcrypt —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
  echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å bcrypt, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫..."
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–æ–º–∞–Ω–¥—É
exec "$@"

